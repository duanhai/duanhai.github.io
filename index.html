<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>swift联盟一员</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="swift联盟一员">
<meta property="og:url" content="/index.html">
<meta property="og:site_name" content="swift联盟一员">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="swift联盟一员">
  
    <link rel="alternate" href="/atom.xml" title="swift联盟一员" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">swift联盟一员</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value=""></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-异步网络请求控制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/12/异步网络请求控制/" class="article-date">
  <time datetime="2018-01-12T03:04:01.000Z" itemprop="datePublished">2018-01-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/12/异步网络请求控制/">iOS多个网络请求完成后执行下一步</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在开发中，我们很容易遇到这样的需求，需要我们同时做多个网络请求，所有网络请求都完成后才能进行下一步的操作。如下载多个图片，下载完了才能展示。今天我们就来研究一下这个问题的解决方案。</p>
<h4 id="1-首先，我们创建一个项目，然后做一般性的做法，不做任何处理去连续请求一个接口10次："><a href="#1-首先，我们创建一个项目，然后做一般性的做法，不做任何处理去连续请求一个接口10次：" class="headerlink" title="1.首先，我们创建一个项目，然后做一般性的做法，不做任何处理去连续请求一个接口10次："></a>1.首先，我们创建一个项目，然后做一般性的做法，不做任何处理去连续请求一个接口10次：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//1.无处理</div><div class="line">    UIButton *Btn1 = [UIButton buttonWithType:UIButtonTypeCustom];</div><div class="line">    Btn1.frame = CGRectMake(100, 100, 100, 40);</div><div class="line">    Btn1.backgroundColor = [UIColor grayColor];</div><div class="line">    [Btn1 setTitle:@&quot;noConduct&quot; forState:UIControlStateNormal];</div><div class="line">    [Btn1 addTarget:self action:@selector(Btn1) forControlEvents:UIControlEventTouchUpInside];</div><div class="line">    [self.view addSubview:Btn1];</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">//1.noConduct</div><div class="line">-(void)Btn1&#123;</div><div class="line">    NSString *str = @&quot;http://www.jianshu.com/p/6930f335adba&quot;;</div><div class="line">    NSURL *url = [NSURL URLWithString:str];</div><div class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</div><div class="line">    NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">    </div><div class="line">    for (int i=0; i&lt;10; i++) &#123;</div><div class="line">        NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">            </div><div class="line">            NSLog(@&quot;%d---%d&quot;,i,i);</div><div class="line">            </div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        [task resume];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSLog(@&quot;end&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">2017-12-04 17:10:10.503 DownImage[3289:261033] end</div><div class="line">2017-12-04 17:10:10.676 DownImage[3289:261080] 0---0</div><div class="line">2017-12-04 17:10:10.704 DownImage[3289:261080] 1---1</div><div class="line">2017-12-04 17:10:10.754 DownImage[3289:261096] 4---4</div><div class="line">2017-12-04 17:10:10.760 DownImage[3289:261080] 2---2</div><div class="line">2017-12-04 17:10:10.800 DownImage[3289:261096] 5---5</div><div class="line">2017-12-04 17:10:10.840 DownImage[3289:261080] 7---7</div><div class="line">2017-12-04 17:10:10.844 DownImage[3289:261082] 6---6</div><div class="line">2017-12-04 17:10:10.846 DownImage[3289:261096] 3---3</div><div class="line">2017-12-04 17:10:10.888 DownImage[3289:261096] 8---8</div><div class="line">2017-12-04 17:10:10.945 DownImage[3289:261080] 9---9</div><div class="line"></div><div class="line">作者：_清墨</div><div class="line">链接：https://www.jianshu.com/p/fb4fb80aefb8</div><div class="line">來源：简书</div><div class="line">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</div></pre></td></tr></table></figure>
<p>很明显，无任何处理情况下，end最先被打印出来，由于网络请求的异步回调，然后各个网络请求的回调顺序是无序的。</p>
<h4 id="2-使用GCD的dispatch-group-t"><a href="#2-使用GCD的dispatch-group-t" class="headerlink" title="2.使用GCD的dispatch_group_t"></a>2.使用GCD的dispatch_group_t</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">//2.group--</div><div class="line">-(void)Btn2&#123;</div><div class="line">    NSString *str = @&quot;http://www.jianshu.com/p/6930f335adba&quot;;</div><div class="line">    NSURL *url = [NSURL URLWithString:str];</div><div class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</div><div class="line">    NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">    </div><div class="line">    dispatch_group_t downloadGroup = dispatch_group_create();</div><div class="line">    for (int i=0; i&lt;10; i++) &#123;</div><div class="line">        dispatch_group_enter(downloadGroup);</div><div class="line">        </div><div class="line">        NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">            </div><div class="line">            NSLog(@&quot;%d---%d&quot;,i,i);</div><div class="line">            dispatch_group_leave(downloadGroup);</div><div class="line">            </div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        [task resume];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    dispatch_group_notify(downloadGroup, dispatch_get_main_queue(), ^&#123;</div><div class="line">        NSLog(@&quot;end&quot;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">2017-12-04 17:14:46.984 DownImage[3289:265374] 2---2</div><div class="line">2017-12-04 17:14:46.987 DownImage[3289:265370] 1---1</div><div class="line">2017-12-04 17:14:47.052 DownImage[3289:265383] 5---5</div><div class="line">2017-12-04 17:14:47.065 DownImage[3289:265370] 4---4</div><div class="line">2017-12-04 17:14:47.111 DownImage[3289:265379] 3---3</div><div class="line">2017-12-04 17:14:47.121 DownImage[3289:265383] 6---6</div><div class="line">2017-12-04 17:14:47.169 DownImage[3289:265383] 7---7</div><div class="line">2017-12-04 17:14:47.192 DownImage[3289:265370] 9---9</div><div class="line">2017-12-04 17:14:47.321 DownImage[3289:265383] 8---8</div><div class="line">2017-12-04 17:14:47.747 DownImage[3289:265374] 0---0</div><div class="line">2017-12-04 17:14:47.747 DownImage[3289:261033] end</div></pre></td></tr></table></figure>
<p>从上两次输出可以看出，end确实是在所有网络请求之后才输出出来，这也是符合了我们的需求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">dispatch_group_t downloadGroup = dispatch_group_create();</div><div class="line">dispatch_group_enter(downloadGroup);</div><div class="line">dispatch_group_leave(downloadGroup);</div><div class="line">dispatch_group_notify(downloadGroup, dispatch_get_main_queue(), ^&#123;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>对以上4行代码可理解为：创建一个dispatch_group_t， 每次网络请求前先dispatch_group_enter,请求回调后再dispatch_group_leave,对于enter和leave必须配合使用，有几次enter就要有几次leave，否则group会一直存在。当所有enter的block都leave后，会执行dispatch_group_notify的block。</p>
<h4 id="3-使用GCD的信号量dispatch-semaphore-t"><a href="#3-使用GCD的信号量dispatch-semaphore-t" class="headerlink" title="3.使用GCD的信号量dispatch_semaphore_t"></a>3.使用GCD的信号量dispatch_semaphore_t</h4> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">//3.semaphore--</div><div class="line">-(void)Btn3&#123;</div><div class="line">    NSString *str = @&quot;http://www.jianshu.com/p/6930f335adba&quot;;</div><div class="line">    NSURL *url = [NSURL URLWithString:str];</div><div class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</div><div class="line">    NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">    </div><div class="line">    dispatch_semaphore_t sem = dispatch_semaphore_create(0);</div><div class="line">    for (int i=0; i&lt;10; i++) &#123;</div><div class="line">        </div><div class="line">        NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">            </div><div class="line">            NSLog(@&quot;%d---%d&quot;,i,i);</div><div class="line">            count++;</div><div class="line">            if (count==10) &#123;</div><div class="line">                dispatch_semaphore_signal(sem);</div><div class="line">                count = 0;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        [task resume];</div><div class="line">    &#125;</div><div class="line">    dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</div><div class="line">    </div><div class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">        NSLog(@&quot;end&quot;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dispatch_semaphore_t sem = dispatch_semaphore_create(0);</div><div class="line">dispatch_semaphore_signal(sem);</div><div class="line">dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</div><div class="line"></div><div class="line"></div><div class="line">对这三句代码可以这样理解：dispatch_semaphore信号量为基于计数器的一种多线程同步机制。如果semaphore计数大于等于1，计数-1，返回，程序继续运行。如果计数为0，则等待。dispatch_semaphore_signal(semaphore)为计数+1操作,dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER)为设置等待时间，这里设置的等待时间是一直等待。</div><div class="line"></div><div class="line">对于以上代码通俗一点就是，开始为0，等待，等10个网络请求都完成了，dispatch_semaphore_signal(semaphore)为计数+1，然后计数-1返回，程序继续执行。 (这里也就是为什么有个count变量的原因，记录网络回调的次数，回调10次之后再发信号量，使后面程序继续运行)。</div></pre></td></tr></table></figure>
<h5 id="4-考虑新需求，10个网络请求顺序回调。"><a href="#4-考虑新需求，10个网络请求顺序回调。" class="headerlink" title="4.考虑新需求，10个网络请求顺序回调。"></a>4.考虑新需求，10个网络请求顺序回调。</h5><p>需求需要顺序回调，即执行完第一个网络请求后，第二个网络请求回调才可被执行，简单来讲就是输出得是0,1,2,3…9这种方式的。</p>
<p>对于这个需求我也是根据自己最近做的项目来提的，因为网络请求回调的异步性，我们虽可以控制网络请求的顺序执行，却不能控制它的完成回调顺序。这就有点伤了，目前我项目是找到了解决方案，但这个问题还没有找到解决办法，提出来跟大家讨论一下。(请忽略网络请求执行，回调，在回调里请求下一个接口的办法，讨论还有没有别的方法,最好show the code).</p>
<p>最后，贴点NSOperation的代码，为了解决新需求所写，由于网络请求回调异步性不能满足需求，但若不是网络请求等异步回调的方式，这样的做法是可以的，大家可以试试.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">//4.NSOperation</div><div class="line">-(void)Btn4&#123;</div><div class="line">    NSString *str = @&quot;http://www.jianshu.com/p/6930f335adba&quot;;</div><div class="line">    NSURL *url = [NSURL URLWithString:str];</div><div class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</div><div class="line">    NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">    </div><div class="line">    NSMutableArray *operationArr = [[NSMutableArray alloc]init];</div><div class="line">    for (int i=0; i&lt;10; i++) &#123;</div><div class="line">        NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">            NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">                </div><div class="line">                NSLog(@&quot;%d---%d&quot;,i,i);</div><div class="line">                </div><div class="line">            &#125;];</div><div class="line">            </div><div class="line">            [task resume];</div><div class="line"></div><div class="line">            //非网络请求</div><div class="line">            NSLog(@&quot;noRequest-%d&quot;,i);</div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        [operationArr addObject:operation];</div><div class="line">        if (i0) &#123;</div><div class="line">            NSBlockOperation *operation1 = operationArr[i-1];</div><div class="line">            NSBlockOperation *operation2 = operationArr[i];</div><div class="line">            [operation2 addDependency:operation1];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSOperationQueue *queue = [[NSOperationQueue alloc]init];</div><div class="line">    [queue addOperations:operationArr waitUntilFinished:NO];  //YES会阻塞当前线程</div><div class="line">#warning - 绝对不要在应用主线程中等待一个Operation,只能在第二或次要线程中等待。阻塞主线程将导致应用无法响应用户事件,应用也将表现为无响应。</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">2017-12-04 18:03:10.224 DownImage[3584:304363] noRequest-0</div><div class="line">2017-12-04 18:03:10.226 DownImage[3584:304362] noRequest-1</div><div class="line">2017-12-04 18:03:10.226 DownImage[3584:304363] noRequest-2</div><div class="line">2017-12-04 18:03:10.231 DownImage[3584:304363] noRequest-3</div><div class="line">2017-12-04 18:03:10.232 DownImage[3584:304362] noRequest-4</div><div class="line">2017-12-04 18:03:10.233 DownImage[3584:304362] noRequest-5</div><div class="line">2017-12-04 18:03:10.233 DownImage[3584:304363] noRequest-6</div><div class="line">2017-12-04 18:03:10.234 DownImage[3584:304363] noRequest-7</div><div class="line">2017-12-04 18:03:10.235 DownImage[3584:304363] noRequest-8</div><div class="line">2017-12-04 18:03:10.236 DownImage[3584:304363] noRequest-9</div><div class="line">2017-12-04 18:03:10.408 DownImage[3584:304597] 2---2</div><div class="line">2017-12-04 18:03:10.408 DownImage[3584:304597] 0---0</div><div class="line">2017-12-04 18:03:10.409 DownImage[3584:304597] 1---1</div><div class="line">2017-12-04 18:03:10.461 DownImage[3584:304597] 5---5</div><div class="line">2017-12-04 18:03:10.476 DownImage[3584:304363] 4---4</div><div class="line">2017-12-04 18:03:10.477 DownImage[3584:304365] 6---6</div><div class="line">2017-12-04 18:03:10.518 DownImage[3584:304365] 7---7</div><div class="line">2017-12-04 18:03:10.537 DownImage[3584:304596] 8---8</div><div class="line">2017-12-04 18:03:10.547 DownImage[3584:304362] 9---9</div><div class="line">2017-12-04 18:03:11.837 DownImage[3584:304362] 3---3</div></pre></td></tr></table></figure>
<h5 id="5-还是使用信号量semaphore完成4的需求"><a href="#5-还是使用信号量semaphore完成4的需求" class="headerlink" title="5.还是使用信号量semaphore完成4的需求"></a>5.还是使用信号量semaphore完成4的需求</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">//5.semaphore--order</div><div class="line">-(void)Btn5&#123;</div><div class="line">    NSString *str = @&quot;http://www.jianshu.com/p/6930f335adba&quot;;</div><div class="line">    NSURL *url = [NSURL URLWithString:str];</div><div class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</div><div class="line">    NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">    </div><div class="line">    dispatch_semaphore_t sem = dispatch_semaphore_create(0);</div><div class="line">    for (int i=0; i&lt;10; i++) &#123;</div><div class="line">        </div><div class="line">        NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">            </div><div class="line">            NSLog(@&quot;%d---%d&quot;,i,i);</div><div class="line">            dispatch_semaphore_signal(sem);</div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        [task resume];</div><div class="line">        dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">        NSLog(@&quot;end&quot;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">2017-12-05 10:17:28.175 DownImage[938:51296] 0---0</div><div class="line">2017-12-05 10:17:28.331 DownImage[938:51289] 1---1</div><div class="line">2017-12-05 10:17:28.506 DownImage[938:51289] 2---2</div><div class="line">2017-12-05 10:17:28.563 DownImage[938:51289] 3---3</div><div class="line">2017-12-05 10:17:28.662 DownImage[938:51289] 4---4</div><div class="line">2017-12-05 10:17:28.733 DownImage[938:51296] 5---5</div><div class="line">2017-12-05 10:17:28.792 DownImage[938:51296] 6---6</div><div class="line">2017-12-05 10:17:28.856 DownImage[938:51286] 7---7</div><div class="line">2017-12-05 10:17:29.574 DownImage[938:51289] 8---8</div><div class="line">2017-12-05 10:17:29.652 DownImage[938:51286] 9---9</div><div class="line">2017-12-05 10:17:29.653 DownImage[938:45252] end</div></pre></td></tr></table></figure>
<p>我们对比 3 的代码，3 中我们只在最后也就是循环结束后调用dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER)，循环中当网络请求回调10次(也就是都回调完)后，使传入的信号量加1:( dispatch_semaphore_signal(sem) ),这时等待结束，然后进行后续的操作。</p>
<p>在这个方法里，我们每一次遍历，都让其dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER)，这个时候线程会等待，阻塞当前线程，直到dispatch_semaphore_signal(sem)调用之后，而我们dispatch_semaphore_signal(sem)是在网络请求的回调里调用的，所以这个方法的逻辑是：</p>
<h5 id="遍历—发起任务—等待—任务完成信号量加1—等待结束-开始下一个任务"><a href="#遍历—发起任务—等待—任务完成信号量加1—等待结束-开始下一个任务" class="headerlink" title="遍历—发起任务—等待—任务完成信号量加1—等待结束,开始下一个任务"></a>遍历—发起任务—等待—任务完成信号量加1—等待结束,开始下一个任务</h5><h5 id="发起任务—等待—任务完成信号量加1—等待结束-开始下一个任务"><a href="#发起任务—等待—任务完成信号量加1—等待结束-开始下一个任务" class="headerlink" title="发起任务—等待—任务完成信号量加1—等待结束,开始下一个任务"></a>发起任务—等待—任务完成信号量加1—等待结束,开始下一个任务</h5><h5 id="发起任务—等待—任务完成信号量加1—等待结束-开始下一个任务-1"><a href="#发起任务—等待—任务完成信号量加1—等待结束-开始下一个任务-1" class="headerlink" title="发起任务—等待—任务完成信号量加1—等待结束,开始下一个任务"></a>发起任务—等待—任务完成信号量加1—等待结束,开始下一个任务</h5><p>这样循环的模式,一个任务完成才能接着去做下面的任务，满足我们的需求。</p>
<p>但我们也要发现这样一个问题，我们使用这种方式，可以明显感觉出整个过程需要花费的时间大大增加了，不像我们 3 中同时(几乎)开启任务等待完成回调，这里是一个网络请求发出，等待，完成后发出第二个网络请求，等待，完成后再发出第三个，这样我们等待的时间是10个网络请求每一个回调时间的和，在时间上大大增加了消耗，而且对于dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER)，它是会阻塞线程的，我们如果需要在网络请求完成后修改UI，那这种方式会影响我们的界面交互,接下来我们对比一下两者时间消耗:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">3-------------3----------3-------</div><div class="line">2017-12-05 10:29:51.178 DownImage[938:56971] 2---2</div><div class="line">2017-12-05 10:29:51.193 DownImage[938:57200] 0---0</div><div class="line">2017-12-05 10:29:51.202 DownImage[938:56631] 3---3</div><div class="line">2017-12-05 10:29:51.248 DownImage[938:56971] 1---1</div><div class="line">2017-12-05 10:29:51.262 DownImage[938:56971] 5---5</div><div class="line">2017-12-05 10:29:51.291 DownImage[938:56631] 6---6</div><div class="line">2017-12-05 10:29:51.375 DownImage[938:56631] 7---7</div><div class="line">2017-12-05 10:29:51.384 DownImage[938:56631] 4---4</div><div class="line">2017-12-05 10:29:51.434 DownImage[938:56971] 8---8</div><div class="line">2017-12-05 10:29:51.487 DownImage[938:57199] 9---9</div><div class="line">2017-12-05 10:29:51.488 DownImage[938:45252] end</div><div class="line"></div><div class="line">5-------------5----------5-------</div><div class="line">2017-12-05 10:29:52.190 DownImage[938:56631] 0---0</div><div class="line">2017-12-05 10:29:52.304 DownImage[938:57199] 1---1</div><div class="line">2017-12-05 10:29:52.432 DownImage[938:56971] 2---2</div><div class="line">2017-12-05 10:29:52.520 DownImage[938:56971] 3---3</div><div class="line">2017-12-05 10:29:52.576 DownImage[938:56631] 4---4</div><div class="line">2017-12-05 10:29:52.628 DownImage[938:56971] 5---5</div><div class="line">2017-12-05 10:29:52.706 DownImage[938:56631] 6---6</div><div class="line">2017-12-05 10:29:52.764 DownImage[938:56971] 7---7</div><div class="line">2017-12-05 10:29:52.853 DownImage[938:56631] 8---8</div><div class="line">2017-12-05 10:29:52.925 DownImage[938:56971] 9---9</div><div class="line">2017-12-05 10:29:52.926 DownImage[938:45252] end</div></pre></td></tr></table></figure>
<p>看得出3花费时间为51.488  -  51.178约300多ms<br>— —5花费时间为52.926 -  52.190约700多ms</p>
<p>所以大家还请谨慎使用。</p>
<p> <a href="https://www.jianshu.com/p/fb4fb80aefb8" target="_blank" rel="external">https://www.jianshu.com/p/fb4fb80aefb8</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2018/01/12/异步网络请求控制/" data-id="cjcbcq6lp000l2xzoaajaktjj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iOS11升级整理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/28/iOS11升级整理/" class="article-date">
  <time datetime="2017-08-28T02:06:35.000Z" itemprop="datePublished">2017-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/28/iOS11升级整理/">iOS11升级整理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>iOS 11适配</p>
<blockquote>
<p><a href="http://www.jianshu.com/p/56a3667ec6b9" target="_blank" rel="external">http://www.jianshu.com/p/56a3667ec6b9</a></p>
<p><a href="http://www.jianshu.com/p/352f101d6df1" target="_blank" rel="external">http://www.jianshu.com/p/352f101d6df1</a></p>
<p><a href="https://github.com/ChenYilong/iOS11AdaptationTips/issues" target="_blank" rel="external">https://github.com/ChenYilong/iOS11AdaptationTips</a></p>
<p>Bugly整理iOS11升级 <a href="http://www.10tiao.com/html/330/201707/2653579210/1.html" target="_blank" rel="external">http://www.10tiao.com/html/330/201707/2653579210/1.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/08/28/iOS11升级整理/" data-id="cjcbcq6lf000e2xzoadzi0k6f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-git-repo无差迁移" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/18/git-repo无差迁移/" class="article-date">
  <time datetime="2017-08-18T02:29:54.000Z" itemprop="datePublished">2017-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/18/git-repo无差迁移/">git repo无差迁移</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Git-repository-数据迁移-包含所有branch-commit等历史信息"><a href="#Git-repository-数据迁移-包含所有branch-commit等历史信息" class="headerlink" title="Git repository 数据迁移(包含所有branch,commit等历史信息)"></a>Git repository 数据迁移(包含所有branch,commit等历史信息)</h4><h5 id="方式1"><a href="#方式1" class="headerlink" title="方式1"></a>方式1</h5><p><code>git clone --bare old@git</code></p>
<p><code>git push --mirror new@git</code></p>
<h5 id="方式2"><a href="#方式2" class="headerlink" title="方式2"></a>方式2</h5><p><code>git remote set-url origin remote_git_address</code></p>
<blockquote>
<p><a href="http://www.jianshu.com/p/e73747d6407f" target="_blank" rel="external">http://www.jianshu.com/p/e73747d6407f</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/08/18/git-repo无差迁移/" data-id="cjcbcq6ld000b2xzow357q0o0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="oc调用c++-c的注意事项" class="article article-type-oc调用c++" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/c的注意事项/" class="article-date">
  <time datetime="2017-08-14T16:43:30.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/c的注意事项/">c的注意事项</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p><em>oc</em> 调用 <em>c</em> <em>c++</em> 需要注意的地方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#ifndef LearnC_h</div><div class="line">#define LearnC_h</div><div class="line"></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">#ifdef __cplusplus</div><div class="line">extern &quot;C&quot; &#123;</div><div class="line">#endif</div><div class="line">void learnCplus(int a, int b);</div><div class="line">    </div><div class="line">#ifdef __cplusplus</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">#endif /* LearnC_h */</div></pre></td></tr></table></figure>
<p><em>hpp</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#ifndef LearnC___hpp</div><div class="line">#define LearnC___hpp</div><div class="line"></div><div class="line">#include &lt;string&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">void learnCplusplus(int a, int b);</div><div class="line"></div><div class="line">class cppObject</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    void exampleMethod(const std::string&amp; str);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">#endif /* LearnC___hpp */</div></pre></td></tr></table></figure>
<p><em>cpp</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">//  LearnC++.cpp</div><div class="line">//  LearnOCandCandC++</div><div class="line">//</div><div class="line">//  Created by 林伟池 on 16/2/23.</div><div class="line">//  Copyright © 2016年 林伟池. All rights reserved.</div><div class="line">//</div><div class="line"></div><div class="line">#include &quot;LearnC++.hpp&quot;</div><div class="line">#include &lt;iostream&gt;</div><div class="line"></div><div class="line">void learnCplusplus(int a, int b) &#123;</div><div class="line">    printf(&quot;cplusplus%d\n&quot;, a + b);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void cppObject::exampleMethod(const std::string &amp;str)</div><div class="line">&#123;</div><div class="line">    std::cout &lt;&lt; str;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#import &quot;LearnC.h&quot;</div><div class="line">#import &quot;LearnC++.hpp&quot;</div><div class="line">#import &quot;LearnOCinCPP.h&quot;</div><div class="line"></div><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line">&#123;</div><div class="line">    cppObject* object;</div><div class="line">&#125;</div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line"></div><div class="line">    learnCplus(1, 2); //在OC中使用c</div><div class="line">    </div><div class="line">    learnCplusplus(1, 2); //在OC中用C++编译的C</div><div class="line">    </div><div class="line">    //在OC中使用C++的类</div><div class="line">    object = new cppObject();</div><div class="line">    NSString* str = @&quot;GAO高级\n&quot;;</div><div class="line">    std::string cpp_str([str UTF8String], [str lengthOfBytesUsingEncoding:NSUTF8StringEncoding]);</div><div class="line">    object-&gt;exampleMethod(cpp_str);</div><div class="line">    delete object;</div><div class="line">    object = NULL; //记得删除</div><div class="line">    </div><div class="line">    </div><div class="line">    //在OC使用的C++类中 使用OC</div><div class="line">    LY::OCinCPP* cpp = new LY::OCinCPP();</div><div class="line">    cpp-&gt;lyRun();</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/loyinglin/LearnCandC-InObjective-C.git" target="_blank" rel="external">参考</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/08/15/c的注意事项/" data-id="cjcbcq6la00092xzomodyjhj5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Lede运行v2ray" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/09/Lede运行v2ray/" class="article-date">
  <time datetime="2017-08-08T17:27:47.000Z" itemprop="datePublished">2017-08-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/09/Lede运行v2ray/">Lede运行v2ray</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="LEDE-运行v2ray不完美的解决办法"><a href="#LEDE-运行v2ray不完美的解决办法" class="headerlink" title="LEDE 运行v2ray不完美的解决办法"></a>LEDE 运行v2ray不完美的解决办法</h4><p><strong>从官网下载v2ray的运行文件放在/usr/bin/v2ray 目录下</strong><br><a href="https://github.com/v2ray/v2ray-core/releases" target="_blank" rel="external">v2ray release 下载</a></p>
<p><strong>将config.json(或者你直接改名为v2ray.json)文件放在/etc/v2ray.json</strong><br><strong>将 /usr/bin/v2ray  和 /etc/v2ray.json 文件赋予权限 直接猛点的权限赋值方法 chomd 777 path </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/v2ray --config /etc/v2ray.json</div></pre></td></tr></table></figure>
<p>对应修改config.json文件后传到自己的lede的对应的目录中去<br>然后在网络设置中–代理—网页代理,安全网络代理中添加 你的路由器ip e.g.   192.168.1.111 加上对应的端口 1080;socks的代理配置同理</p>
<p><strong> 如果inbound 中的protocol: socks,需要在settings中增加 “auth”: “noauth” </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;inbound&quot;: &#123;</div><div class="line">   &quot;port&quot;: 1080,</div><div class="line">   &quot;protocol&quot;: &quot;socks&quot;,</div><div class="line">   &quot;settings&quot;: &#123;</div><div class="line">     &quot;auth&quot;: &quot;noauth&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;log&quot;: &#123;</div><div class="line">    &quot;error&quot;: &quot;/var/log/v2ray/error.log&quot;,</div><div class="line">    &quot;loglevel&quot;: &quot;warning&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;inbound&quot;: &#123;</div><div class="line">    &quot;port&quot;: 1080,</div><div class="line">    &quot;protocol&quot;: &quot;http&quot;,</div><div class="line">    &quot;settings&quot;: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;outbound&quot;: &#123;</div><div class="line">    &quot;protocol&quot;: &quot;vmess&quot;,</div><div class="line">    &quot;settings&quot;: &#123;</div><div class="line">      &quot;vnext&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;address&quot;: &quot;v2ray.cool&quot;,</div><div class="line">          &quot;port&quot;: 10086,</div><div class="line">          &quot;users&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;id&quot;: &quot;a3482e88-686a-4a58-8126-99c9df64b7bf&quot;,</div><div class="line">              &quot;alterId&quot;: 64,</div><div class="line">              &quot;security&quot;: &quot;auto&quot;</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;mux&quot;: &#123;</div><div class="line">      &quot;enabled&quot;: true</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;outboundDetour&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;protocol&quot;: &quot;freedom&quot;,</div><div class="line">      &quot;settings&quot;: &#123;&#125;,</div><div class="line">      &quot;tag&quot;: &quot;direct&quot;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  &quot;dns&quot;: &#123;</div><div class="line">    &quot;servers&quot;: [</div><div class="line">      &quot;8.8.8.8&quot;,</div><div class="line">      &quot;8.8.4.4&quot;,</div><div class="line">      &quot;localhost&quot;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;routing&quot;: &#123;</div><div class="line">    &quot;strategy&quot;: &quot;rules&quot;,</div><div class="line">    &quot;settings&quot;: &#123;</div><div class="line">      &quot;domainStrategy&quot;: &quot;IPIfNonMatch&quot;,</div><div class="line">      &quot;rules&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;field&quot;,</div><div class="line">          &quot;port&quot;: &quot;1-52&quot;,</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;field&quot;,</div><div class="line">          &quot;port&quot;: &quot;54-79&quot;,</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;field&quot;,</div><div class="line">          &quot;port&quot;: &quot;81-442&quot;,</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;field&quot;,</div><div class="line">          &quot;port&quot;: &quot;444-65535&quot;,</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;chinasites&quot;,</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;field&quot;,</div><div class="line">          &quot;ip&quot;: [</div><div class="line">            &quot;0.0.0.0/8&quot;,</div><div class="line">            &quot;10.0.0.0/8&quot;,</div><div class="line">            &quot;100.64.0.0/10&quot;,</div><div class="line">            &quot;127.0.0.0/8&quot;,</div><div class="line">            &quot;169.254.0.0/16&quot;,</div><div class="line">            &quot;172.16.0.0/12&quot;,</div><div class="line">            &quot;192.0.0.0/24&quot;,</div><div class="line">            &quot;192.0.2.0/24&quot;,</div><div class="line">            &quot;192.168.0.0/16&quot;,</div><div class="line">            &quot;198.18.0.0/15&quot;,</div><div class="line">            &quot;198.51.100.0/24&quot;,</div><div class="line">            &quot;203.0.113.0/24&quot;,</div><div class="line">            &quot;::1/128&quot;,</div><div class="line">            &quot;fc00::/7&quot;,</div><div class="line">            &quot;fe80::/10&quot;</div><div class="line">          ],</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;chinaip&quot;,</div><div class="line">          &quot;outboundTag&quot;: &quot;direct&quot;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h5 id="最新更新2017-8-16"><a href="#最新更新2017-8-16" class="headerlink" title="最新更新2017 8.16"></a>最新更新2017 8.16</h5><blockquote>
<p><a href="https://github.com/v2ray/v2ray-core/issues/483" target="_blank" rel="external">https://github.com/v2ray/v2ray-core/issues/483</a><br>用otaku的一段代码实现了v2ray的进程守护</p>
</blockquote>
<p>还是放在 /etc/init.d/v2ray</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">START=90</div><div class="line"></div><div class="line">USE_PROCD=1</div><div class="line">start_service() &#123;</div><div class="line">  mkdir /var/log/v2ray &gt; /dev/null 2&gt;&amp;1</div><div class="line">  procd_open_instance</div><div class="line">  procd_set_param respawn</div><div class="line">  procd_set_param command /usr/bin/v2ray -config /etc/v2ray/config.json</div><div class="line">  procd_set_param file /etc/v2ray/config.json</div><div class="line">  procd_set_param stdout 1</div><div class="line">  procd_set_param stderr 1</div><div class="line">  procd_set_param pidfile /var/run/v2ray.pid</div><div class="line">  procd_close_instance</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/08/09/Lede运行v2ray/" data-id="cjcbcq6l500052xzok23i71t9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-v2ray" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/31/v2ray/" class="article-date">
  <time datetime="2017-07-30T16:00:00.000Z" itemprop="datePublished">2017-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/31/v2ray/">V2Ray 配置ss &amp; vmess</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="V2Ray-配置文件设置"><a href="#V2Ray-配置文件设置" class="headerlink" title="V2Ray 配置文件设置"></a>V2Ray 配置文件设置</h4><p><strong> 满足VMESS &amp; SS协议 </strong></p>
<h4 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h4><p>1 (以搬瓦工的Center OS 7 bbr)先用ssh登录 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh root@162.219.121.23x -p 27530</div></pre></td></tr></table></figure>
<p>2 Bash命令安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash &lt;(curl -L -s https://install.direct/go.sh)</div></pre></td></tr></table></figure>
<p>3 编辑服务端配置文件满足VMESS &amp; SS协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/v2ray/config.json</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;log&quot; : &#123;</div><div class="line">    &quot;access&quot;: &quot;/var/log/v2ray/access.log&quot;,</div><div class="line">    &quot;error&quot;: &quot;/var/log/v2ray/error.log&quot;,</div><div class="line">    &quot;loglevel&quot;: &quot;warning&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;inbound&quot;: &#123;</div><div class="line">    &quot;port&quot;: 21059,</div><div class="line">    &quot;protocol&quot;: &quot;vmess&quot;,</div><div class="line">    &quot;settings&quot;: &#123;</div><div class="line">      &quot;clients&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;id&quot;: &quot;7ce007bc-47ea-45c1-9294-e37168186c4e&quot;,</div><div class="line">          &quot;level&quot;: 1,</div><div class="line">          &quot;alterId&quot;: 64</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;outbound&quot;: &#123;</div><div class="line">    &quot;protocol&quot;: &quot;freedom&quot;,</div><div class="line">    &quot;settings&quot;: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">&quot;inboundDetour&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;protocol&quot;: &quot;shadowsocks&quot;, </div><div class="line">      &quot;port&quot;: 21058, </div><div class="line">      &quot;settings&quot;: &#123;</div><div class="line">        &quot;method&quot;: &quot;aes-256-cfb&quot;,</div><div class="line">        &quot;password&quot;: &quot;v2ray&quot;,     </div><div class="line">        &quot;udp&quot;: false            </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  &quot;outboundDetour&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;protocol&quot;: &quot;blackhole&quot;,</div><div class="line">      &quot;settings&quot;: &#123;&#125;,</div><div class="line">      &quot;tag&quot;: &quot;blocked&quot;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  &quot;routing&quot;: &#123;</div><div class="line">    &quot;strategy&quot;: &quot;rules&quot;,</div><div class="line">    &quot;settings&quot;: &#123;</div><div class="line">      &quot;rules&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;type&quot;: &quot;field&quot;,</div><div class="line">          &quot;ip&quot;: [</div><div class="line">            &quot;0.0.0.0/8&quot;,</div><div class="line">            &quot;10.0.0.0/8&quot;,</div><div class="line">            &quot;100.64.0.0/10&quot;,</div><div class="line">            &quot;127.0.0.0/8&quot;,</div><div class="line">            &quot;169.254.0.0/16&quot;,</div><div class="line">            &quot;172.16.0.0/12&quot;,</div><div class="line">            &quot;192.0.0.0/24&quot;,</div><div class="line">            &quot;192.0.2.0/24&quot;,</div><div class="line">            &quot;192.168.0.0/16&quot;,</div><div class="line">            &quot;198.18.0.0/15&quot;,</div><div class="line">            &quot;198.51.100.0/24&quot;,</div><div class="line">            &quot;203.0.113.0/24&quot;,</div><div class="line">            &quot;::1/128&quot;,</div><div class="line">            &quot;fc00::/7&quot;,</div><div class="line">            &quot;fe80::/10&quot;</div><div class="line">          ],</div><div class="line">          &quot;outboundTag&quot;: &quot;blocked&quot;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="配置文件设置好后，可以用命令测试"><a href="#配置文件设置好后，可以用命令测试" class="headerlink" title="配置文件设置好后，可以用命令测试"></a>配置文件设置好后，可以用命令测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./v2ray --test --config v2ray-client.json</div></pre></td></tr></table></figure>
<h4 id="启动相关命令"><a href="#启动相关命令" class="headerlink" title="启动相关命令"></a>启动相关命令</h4><blockquote>
<ol>
<li><p>编辑 /etc/v2ray/config.json 文件来配置你需要的代理方式；</p>
</li>
<li><p>运行 service v2ray start 来启动 V2Ray 进程；</p>
</li>
<li><p>之后可以使用 service v2ray start|stop|status|reload|restart|force-reload 控制 V2Ray 的运行</p>
</li>
</ol>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service v2ray status | start ...</div></pre></td></tr></table></figure>
<h4 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h4><p><strong> 以上配置适用于root权限下操作，若由于权限不足请自行搜索解决 </strong></p>
<p><strong> 如果遇到ssh无法登录的情况，可以先rm ~/.ssh/xxx 对应的文件然后再重新连接 </strong></p>
<p><strong> <a href="https://www.uuidgenerator.net" target="_blank" rel="external">uuid生成网站</a> </strong></p>
<p><strong> <a href="https://www.ipip.net/traceroute.php" target="_blank" rel="external">路由追踪</a> </strong></p>
<p><strong> <a href="https://htfy96.github.io/v2ray-config-gen/" target="_blank" rel="external">配置生成器</a> </strong></p>
<p>这个配置生成只有一种协议，如果要支持多种协议，请参考上面贴出的code,分别为 <strong> inbound </strong> 和 <strong> inboundDetour </strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/07/31/v2ray/" data-id="cjcbcq6lj000i2xzo16qmk7a0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/V2Ray/">V2Ray</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-在 iOS8以上工程创建通用的framework" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/26/在 iOS8以上工程创建通用的framework/" class="article-date">
  <time datetime="2017-07-26T03:28:01.000Z" itemprop="datePublished">2017-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/26/在 iOS8以上工程创建通用的framework/">在 iOS8以上工程创建通用的framework</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="在-iOS8以上工程创建通用的framework-以及如何适配-swift-module"><a href="#在-iOS8以上工程创建通用的framework-以及如何适配-swift-module" class="headerlink" title="在 iOS8以上工程创建通用的framework 以及如何适配 swift module"></a>在 iOS8以上工程创建通用的framework 以及如何适配 swift module</h4><p><a href="https://stackoverflow.com/questions/39890114/creating-a-universal-framework-using-xcode-8" target="_blank" rel="external">参考链接</a></p>
<p><a href="https://gist.github.com/duanhai/03cf0af22d40e3536421d90a64fc28e0" target="_blank" rel="external">改良链接</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line"></div><div class="line">UNIVERSAL_OUTPUTFOLDER=$&#123;BUILD_DIR&#125;/$&#123;CONFIGURATION&#125;-universal</div><div class="line"></div><div class="line"># make sure the output directory exists</div><div class="line">mkdir -p &quot;$&#123;UNIVERSAL_OUTPUTFOLDER&#125;/iOS&quot;</div><div class="line"></div><div class="line"># Step 1. Build Device and Simulator versions on iOS</div><div class="line">xcodebuild -workspace &quot;$&#123;PROJECT_NAME&#125;.xcworkspace&quot; -scheme &quot;$&#123;PROJECT_NAME&#125;&quot;  -sdk iphonesimulator -destination &apos;platform=iOS Simulator,name=iPhone 6&apos; clean build</div><div class="line">xcodebuild -workspace &quot;$&#123;PROJECT_NAME&#125;.xcworkspace&quot; -scheme &quot;$&#123;PROJECT_NAME&#125;&quot; -sdk iphoneos clean build</div><div class="line"></div><div class="line"># Step 2. Copy the framework structure (from iphoneos build) to the universal folder</div><div class="line">cp -R &quot;$&#123;BUILD_DIR&#125;/$&#123;CONFIGURATION&#125;-iphoneos/$&#123;PROJECT_NAME&#125;.framework&quot; &quot;$&#123;UNIVERSAL_OUTPUTFOLDER&#125;/iOS&quot;</div><div class="line"></div><div class="line"># Step 3. Create universal binary file using lipo and place the combined executable in the copied framework directory</div><div class="line">lipo -create -output &quot;$&#123;UNIVERSAL_OUTPUTFOLDER&#125;/iOS/$&#123;PROJECT_NAME&#125;.framework/$&#123;PROJECT_NAME&#125;&quot; &quot;$&#123;BUILD_DIR&#125;/$&#123;CONFIGURATION&#125;-iphonesimulator/$&#123;PROJECT_NAME&#125;.framework/$&#123;PROJECT_NAME&#125;&quot; &quot;$&#123;BUILD_DIR&#125;/$&#123;CONFIGURATION&#125;-iphoneos/$&#123;PROJECT_NAME&#125;.framework/$&#123;PROJECT_NAME&#125;&quot;</div><div class="line"></div><div class="line"># Step 4. Convenience step to copy the framework to the project&apos;s directory</div><div class="line">mkdir -p &quot;$&#123;TMPDIR&#125;/$&#123;PROJECT_NAME&#125;/Frameworks/iOS&quot;</div><div class="line"></div><div class="line">cp -R &quot;$&#123;UNIVERSAL_OUTPUTFOLDER&#125;/iOS/$&#123;PROJECT_NAME&#125;.framework&quot; &quot;$&#123;TMPDIR&#125;/$&#123;PROJECT_NAME&#125;/Frameworks/iOS&quot;</div><div class="line"></div><div class="line"></div><div class="line"># Step 6. Create .tar.gz file for posting on the binary repository</div><div class="line">cd &quot;$&#123;TMPDIR&#125;&quot;</div><div class="line"></div><div class="line"># We nest the framework inside a Frameworks folder so that it unarchives correctly</div><div class="line">tar -zcf &quot;$&#123;PROJECT_NAME&#125;.framework.tar.gz&quot; &quot;$&#123;PROJECT_NAME&#125;/Frameworks/&quot;</div><div class="line">mv &quot;$&#123;PROJECT_NAME&#125;.framework.tar.gz&quot; &quot;$&#123;PROJECT_DIR&#125;/&quot;</div><div class="line"></div><div class="line"># Step 7. Convenience step to open the project&apos;s directory in Finder</div><div class="line">#open &quot;$&#123;PROJECT_DIR&#125;&quot;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/07/26/在 iOS8以上工程创建通用的framework/" data-id="cjcbcq6lq000m2xzof0v2u34i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-BeSquare的简单配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/24/BeSquare的简单配置/" class="article-date">
  <time datetime="2017-07-24T03:28:01.000Z" itemprop="datePublished">2017-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/24/BeSquare的简单配置/">BS fastlane的简单配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="简要记录如何通过-fastlane-和-jenkins实现自动打包上传蒲公英"><a href="#简要记录如何通过-fastlane-和-jenkins实现自动打包上传蒲公英" class="headerlink" title="简要记录如何通过 fastlane 和 jenkins实现自动打包上传蒲公英"></a>简要记录如何通过 fastlane 和 jenkins实现自动打包上传蒲公英</h4><p><strong> 环境: 1.Xcode 8.3.x 2.Jenkins 3.Fastlane </strong></p>
<p> 初次使用使用<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastlane init</div></pre></td></tr></table></figure></p>
<p>输入对应的 apple id 账号和密码</p>
<p>下面我将粘贴 fastlane 目录结构的对应文件的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Fastlane</div><div class="line">        --- Appfile</div><div class="line">        --- Fastfile</div><div class="line">        --- Pluginfile //新版本中貌似不这样使用了</div></pre></td></tr></table></figure>
<p>Appfile</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app_identifier &quot;com.XXX.app.suza.beta&quot; # The bundle identifier of your app</div><div class="line">apple_id &quot;hai.duan@XXX.com.cn&quot; # Your Apple email address</div><div class="line"></div><div class="line">team_id &quot;XXX&quot;  # Developer Portal Team ID</div><div class="line"></div><div class="line"># you can even provide different app identifiers, Apple IDs and team names per lane:</div><div class="line"># More information: https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Appfile.md</div></pre></td></tr></table></figure>
<p>Fastfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"># update_fastlane</div><div class="line"># Update this, if you use features of a newer version</div><div class="line"></div><div class="line">fastlane_version &quot;2.23.0&quot;</div><div class="line"></div><div class="line">default_platform :ios</div><div class="line"></div><div class="line">platform :ios do</div><div class="line">  before_all do</div><div class="line">    cocoapods</div><div class="line">  end</div><div class="line">  desc &quot;Runs all the tests&quot;</div><div class="line">  lane :test do</div><div class="line">    scan</div><div class="line">  end</div><div class="line"></div><div class="line">  desc &quot;Submit a new Beta Build to Apple TestFlight&quot;</div><div class="line">  desc &quot;This will also make sure the profile is up to date&quot;</div><div class="line"></div><div class="line">  lane :beta do</div><div class="line">    # match(type: &quot;appstore&quot;) # more information: https://codesigning.guide</div><div class="line">    gym(scheme: &quot;BeSquare Beta&quot;,export_method: &quot;ad-hoc&quot;) # Build your app - more options available</div><div class="line">    #pilot</div><div class="line"></div><div class="line">    # sh &quot;your_script.sh&quot;</div><div class="line">    # You can also use other beta testing services here (run `fastlane actions`)</div><div class="line">  end</div><div class="line"></div><div class="line">  desc &quot;Deploy a new version to the App Store&quot;</div><div class="line">  lane :release do</div><div class="line">    # match(type: &quot;appstore&quot;)</div><div class="line">    # snapshot</div><div class="line">    gym(scheme: &quot;BeSquare Beta&quot;,export_method: &quot;appstore&quot;) # Build your app - more options available</div><div class="line">    deliver(force: true)</div><div class="line">    # frameit</div><div class="line">  end</div><div class="line"></div><div class="line">  # You can define as many lanes as you want</div><div class="line"></div><div class="line">  after_all do |lane|</div><div class="line">    # This block is called, only if the executed lane was successful</div><div class="line"></div><div class="line">    # slack(</div><div class="line">    #   message: &quot;Successfully deployed new App Update.&quot;</div><div class="line">    # )</div><div class="line">  end</div><div class="line"></div><div class="line">  error do |lane, exception|</div><div class="line">    # slack(</div><div class="line">    #   message: exception.message,</div><div class="line">    #   success: false</div><div class="line">    # )</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>Jenkins<br>      —- Execute shell<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">pwd</div><div class="line">cd SUZA</div><div class="line">fastlane beta</div><div class="line"></div><div class="line">GIT_COMMIT_MSG=`git log -1 --pretty=%h:%an:%B`</div><div class="line">curl -F &quot;updateDescription=$&#123;GIT_COMMIT_MSG&#125;&quot; -F &quot;file=@/Users/duanhai/.jenkins/workspace/XXX/XX22DD/XXX Beta.ipa&quot; -F &quot;uKey=27ee4291086a9ba71c2f890e3d0bdc20&quot; -F &quot;_api_key=729c278fe701cc64bcf9eb14d83fd2fa&quot; https://qiniu-storage.pgyer.com/apiv1/app/upload</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/07/24/BeSquare的简单配置/" data-id="cjcbcq6kz00022xzoxrecbfam" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-kiwiDoc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/24/kiwiDoc/" class="article-date">
  <time datetime="2017-05-24T06:39:19.000Z" itemprop="datePublished">2017-05-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/24/kiwiDoc/">kiwiDoc</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Kiwi人脸跟踪SDK快速集成指南-iOS"><a href="#Kiwi人脸跟踪SDK快速集成指南-iOS" class="headerlink" title="Kiwi人脸跟踪SDK快速集成指南(iOS)"></a>Kiwi人脸跟踪SDK快速集成指南(iOS)</h1><p>kiwi人脸跟踪SDK，主要功能包括：</p>
<ul>
<li>静态图片的人脸以及关键点位置检测</li>
<li>68个人脸关键点的实时检测与跟踪（单人脸/多人脸）</li>
<li>美颜、哈哈镜等实时滤镜功能</li>
<li>人脸Pose参数估计</li>
<li>趣味2D贴纸</li>
</ul>
<p>我们的SDK针对移动端，在算法效率、硬件占用、性能精度等方面进行了相关优化，使其适用于移动端直播，美颜相机，滤镜相机，趣味贴纸，虚拟美妆等应用场景。</p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>  <img src="images/IOSpixelbuffer.png" alt=""></p>
<p>这个文档将演示如何利用我们的demo快速入门，并详细描述具体集成步骤。</p>
<h2 id="Demo快速入门"><a href="#Demo快速入门" class="headerlink" title="Demo快速入门"></a>Demo快速入门</h2><p>该demo基于七牛的直播SDK，实现了在直播的场景下实现人脸跟踪以及趣味贴纸。</p>
<h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><h6 id="开发环境要求"><a href="#开发环境要求" class="headerlink" title="开发环境要求"></a>开发环境要求</h6><p>  软件</p>
<pre><code>* XCode 6.0 或以上版本
* iOS 7.0 或以上版本
</code></pre><p>  硬件</p>
<pre><code>* 支持语音/视频的真机设备
</code></pre><h4 id="编译代码示例"><a href="#编译代码示例" class="headerlink" title="编译代码示例"></a>编译代码示例</h4><ol>
<li><p>用XCode打开demo工程文件(PLMediaStreamingKitDemo)。代码包含以下目录结构</p>
<p><img src="images/ios-project.jpg" alt=""></p>
</li>
<li><p>选中项目，如下图所示，点击 “Build and Run” 按钮进行编译</p>
<p>示例截图</p>
</li>
</ol>
<p><img src="images/31.pic_hd.jpg" alt=""> | <img src="images/33.pic_hd.jpg" alt=""> |</p>
<p>p.s. 该示例只支持在真机上实现功能，不支持模拟器。编译完成后，即可运行。</p>
<h2 id="具体集成步骤"><a href="#具体集成步骤" class="headerlink" title="具体集成步骤"></a>具体集成步骤</h2><h4 id="第一步：准备环境"><a href="#第一步：准备环境" class="headerlink" title="第一步：准备环境"></a>第一步：准备环境</h4><p>软件</p>
<ul>
<li>XCode 6.0 或以上版本</li>
<li>iOS 7.0 或以上版本</li>
</ul>
<p>硬件</p>
<ul>
<li>支持语音/视频的真机设备</li>
</ul>
<h4 id="第二步：项目所需库"><a href="#第二步：项目所需库" class="headerlink" title="第二步：项目所需库"></a>第二步：项目所需库</h4><ul>
<li><strong>kiwi提供</strong>（请从sdk文件夹中获取）<ul>
<li>libfaceTrackerSDK.a（人脸捕捉SDK）</li>
<li>libKiwiFaceSDK.a（UI＋视频帧渲染SDK）</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>自行下载</strong>（若项目中已经存在则不需要下载）</p>
<p>必选：</p>
<ul>
<li>GPUImage视频渲染基于GPUImage SDK<br><a href="https://github.com/BradLarson/GPUImage.git" target="_blank" rel="external">https://github.com/BradLarson/GPUImage.git</a></li>
<li>opencv3.framework<br><a href="https://sourceforge.net/projects/opencvlibrary/files/opencv-ios/3.0.0/" target="_blank" rel="external">https://sourceforge.net/projects/opencvlibrary/files/opencv-ios/3.0.0/</a></li>
</ul>
<p>可选：</p>
<ul>
<li>libyuv (sdk视频帧的渲染暂时只支持NV21格式的传入，如果应用视频帧是YUV或者其他视频流类型，需要导入视频流格式的转换类)<br><a href="https://github.com/lemenkov/libyuv.git" target="_blank" rel="external">https://github.com/lemenkov/libyuv.git</a></li>
</ul>
</li>
</ul>
<ul>
<li><strong>系统库</strong> （xcode自带）<ul>
<li>UIKit.framework</li>
<li>Foundation.framework</li>
</ul>
</li>
</ul>
<h4 id="第三步：部署工程"><a href="#第三步：部署工程" class="headerlink" title="第三步：部署工程"></a>第三步：部署工程</h4><pre><code>1. 导入 libKiwiFaceSDK.a 文件和所有包含的头文件、实现文件、资源文件。（我们提供了两种libKiwiFaceSDK.a文件。libKiwiFaceSDK.a同时支持模拟器与真机，供开发调试使用。libKiwiFaceSDK_release.a仅支持真机，供发布使用。）

  ![](images/KiwiFaceSDK.jpg)

2. 导入Tracker 人脸捕捉的SDK包和StickerManager。（我们提供了两种libfaceTrackerSDK.a文件。libfaceTrackerSDK_lic.a同时支持模拟器与真机，供开发调试使用。libfaceTrackerSDK_release.a仅支持真机，供发布使用。）

  ![](images/Tracker.jpg)

  ![](images/StickerManager.jpg)

  这里注意tracker包的models文件夹和StickerManager文件夹下的stickers贴纸文件夹，必须只是导入引用，不要包含到项目工程里面来(文件夹图标为蓝色)。如下图设置：

  ![](images/target-settings.png)

3. 导入GPUImage，用于视频渲染（我们提供了两种libGPUImage.a文件。libGPUImage.a同时支持模拟器与真机，供开发调试使用。libGPUImage_release.a仅支持真机，供发布使用。）

4. 如有需要，导入libyuv

  sdk视频帧的渲染暂时只支持NV21格式的传入 如果应用视频帧是YUV或者其他视频流类型 需要导入视频流格式的转换类。

5. 导入 opencv3.framework

  注意，从官网下载的包有可能被错误的命名为opencv2.framework。
</code></pre><h4 id="第四步：贴纸配置"><a href="#第四步：贴纸配置" class="headerlink" title="第四步：贴纸配置"></a>第四步：贴纸配置</h4><p>  如果有需要，请配置贴纸。贴纸相关文件存放在stickers目录下，一套贴纸对应一个目录，每套贴纸包含一个config.json文件，其中配置了音效文件名及每个item参数等信息。其结构如下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">|--[sticker_1] （贴纸1）</div><div class="line">|   |--config.json （贴纸配置文件）</div><div class="line">|   |--[audio]（音频文件）</div><div class="line">|   |--[preview]（贴纸预览图）</div><div class="line">|   |--[item_1]（贴纸序列图文件夹1）</div><div class="line">|   |   |--[frame_1]（贴纸序列图1）</div><div class="line">|   |   |--[frame_2]（贴纸序列图2）</div><div class="line">|   |   |--...</div><div class="line">|   |   |--[frame_n]（贴纸序列图n）</div><div class="line">|   |--[item_2]（贴纸序列图文件夹2）</div><div class="line">|   |--...</div><div class="line">|   |--[item_n]（贴纸序列图文件夹n）</div><div class="line">|--[sticker_2]（贴纸2）</div><div class="line">|--...</div><div class="line">|--[sticker_n]（贴纸n）</div><div class="line">|—StickerConfig.json（总配置文件）</div></pre></td></tr></table></figure>
<p>  程序靠读取在stickers文件夹下的StickerConfig.json显示相应的贴纸和图标。</p>
<p>注意，使用贴纸云，需要在Info.plist中加入App Transport Security Settings字段，并将Allow Arbitrary Loads设置为YES。<br>  <strong>具体的json文件格式如下：</strong></p>
<p>  StickerConfig.json</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>    name</td>
<td>贴纸的名称（UI显示和贴纸的识别）</td>
</tr>
<tr>
<td>    dir</td>
<td>贴纸存放路径文件夹名称</td>
</tr>
<tr>
<td>    category</td>
<td>类别（贴纸类型的区分或分组）</td>
</tr>
<tr>
<td>    thumb</td>
<td>贴纸图标的文件名（与声音在同一文件夹下）</td>
</tr>
<tr>
<td>    voiced</td>
<td>true（有声音）false（没有声音播放）</td>
</tr>
<tr>
<td>    downloaded</td>
<td>是否已经下载。如果没有下载，程序则可以去下载到指定目录后更改该状态</td>
</tr>
</tbody>
</table>
<p>  config.json</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>    type</td>
<td>贴纸显示的位置类型（脸部、全屏）</td>
</tr>
<tr>
<td>    facePos</td>
<td>贴纸在脸部的位置</td>
</tr>
<tr>
<td>    scaleWidthOffset</td>
<td>贴纸宽度缩放系数</td>
</tr>
<tr>
<td>    scaleHeightOffset</td>
<td>贴纸高度缩放系数</td>
</tr>
<tr>
<td>    scaleXOffset</td>
<td>贴纸在脸部水平方向偏移系数</td>
</tr>
<tr>
<td>    scaleYOffset</td>
<td>贴纸在脸部垂直方向偏移系数</td>
</tr>
<tr>
<td>    alignPos</td>
<td>边缘item参数</td>
</tr>
<tr>
<td>    alignX</td>
<td>边缘水平方向偏移系数</td>
</tr>
<tr>
<td>    alignY</td>
<td>边缘垂直方向系数</td>
</tr>
<tr>
<td>    frameFolder</td>
<td>贴纸资源目录（包括一组图片序列帧）</td>
</tr>
<tr>
<td>    frameNum</td>
<td>帧数（一组序列帧组成一个动画效果）</td>
</tr>
<tr>
<td>    frameDuration</td>
<td>每帧的间隔（秒）</td>
</tr>
<tr>
<td>    frameWidth</td>
<td>图片的宽</td>
</tr>
<tr>
<td>    frameHeight</td>
<td>图片的高</td>
</tr>
<tr>
<td>    trigerType</td>
<td>触发条件，默认0，始终显示</td>
</tr>
</tbody>
</table>
<p>  编写config.json文件可使用我司提供的工具 <a href="https://apps.kiwiapp.mobi/sticker.html" target="_blank" rel="external">https://apps.kiwiapp.mobi/sticker.html</a> 进行调试生成。</p>
<h4 id="第五步：调用API"><a href="#第五步：调用API" class="headerlink" title="第五步：调用API"></a>第五步：调用API</h4><h6 id="使用SDK内置UI"><a href="#使用SDK内置UI" class="headerlink" title="使用SDK内置UI"></a>使用SDK内置UI</h6><p>如果直接使用我们SDK内置的UI, 可以在页面的viewDidload里面初始化SDK。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 获得SDK操作类的实例对象 */</span></div><div class="line">self.kwSdkUI = [KiwiFaceSDK_UI shareManagerUI];</div><div class="line"><span class="comment">/* 设置SDK内置UI的 ViewController 如果不用内置UI 不用设置 */</span></div><div class="line">[self.kwSdkUI setViewDelegate:self];</div><div class="line"><span class="comment">/* 初始化SDK 一些渲染对象以及初始参数 */</span></div><div class="line">[self.kwSdkUI.kwSdk initSdk];</div><div class="line"><span class="comment">/* 如果使用内置UI 该属性是判断是否清除原有项目的页面UI 如果原有UI功能少 可以用内置UI 替代 一般来说用不到 */</span></div><div class="line">self.kwSdkUI.isClearOldUI = NO;</div><div class="line"> <span class="comment">/* 初始化内置UI */</span></div><div class="line">[self.kwSdkUI initSDKUI];</div><div class="line"> <span class="comment">/* 渲染视频帧，在每一帧视频代理函数中调用 */</span></div><div class="line">self.kwSdkUI.kwSdk = [KiwiFaceSDK sharedManager];</div><div class="line"><span class="comment">/*</span></div><div class="line">对每一帧的视频图像进行人脸捕捉 并对当前选择的滤镜进行视频帧渲染</div><div class="line">pixelBuffer：每一帧的像素流</div><div class="line">cvMobileRotate ：屏幕方向（横竖屏）</div><div class="line">mirrored： 是否是镜像</div><div class="line">*/</div><div class="line">[kwSdk.renderer processPixelBuffer:pixelBuffer withRotation:cvMobileRotate mirrored:mirrored];</div></pre></td></tr></table></figure>
<h6 id="使用sdk自带功能"><a href="#使用sdk自带功能" class="headerlink" title="使用sdk自带功能"></a>使用sdk自带功能</h6><ul>
<li><p>初始化具体功能：</p>
<ul>
<li><p>初始化普通滤镜或贴纸集合</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">self.filters = @[</div><div class="line">   <span class="comment">//描点</span></div><div class="line">   [FTPointsRenderer <span class="keyword">new</span>],</div><div class="line">   <span class="comment">//贴纸</span></div><div class="line">   [FTStickerRenderer <span class="keyword">new</span>]</div><div class="line">];</div></pre></td></tr></table></figure>
</li>
<li><p>初始化哈哈镜滤镜集合</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">self.distortionFilters = @[</div><div class="line">     <span class="comment">//方脸</span></div><div class="line">     [GPUImageSquareFaceFilter <span class="keyword">new</span>],</div><div class="line">     <span class="comment">//ET脸</span></div><div class="line">     [ETnewFilter <span class="keyword">new</span>],</div><div class="line">     <span class="comment">//胖脸</span></div><div class="line">     [FatFaceFilter <span class="keyword">new</span>],</div><div class="line">     <span class="comment">//蛇精脸</span></div><div class="line">     [SlimFaceFilter <span class="keyword">new</span>],</div><div class="line">     <span class="comment">//梨脸</span></div><div class="line">     [PearFaceDistortionFilter <span class="keyword">new</span>]</div><div class="line">];</div></pre></td></tr></table></figure>
</li>
<li><p>初始化美颜滤镜集合</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">self.beautifyFilters = @[</div><div class="line">     <span class="comment">//大眼</span></div><div class="line">     [SmallFaceBigEyeFilter <span class="keyword">new</span>]</div><div class="line">];</div><div class="line"></div><div class="line">self.beautifyNewFilters = @[</div><div class="line">     <span class="comment">//美颜</span></div><div class="line">     [GPUImageBeautifyFilter <span class="keyword">new</span>]</div><div class="line">];</div></pre></td></tr></table></figure>
</li>
<li><p>初始化全局滤镜集合</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">self.lookupFilters = @[</div><div class="line">     <span class="comment">//Nature</span></div><div class="line">     [[FTLookupFilter alloc] initWithType:FTLookupTypeNature],</div><div class="line">     <span class="comment">//Sweety</span></div><div class="line">     [[FTLookupFilter alloc] initWithType:FTLookupTypeSweety],</div><div class="line">     <span class="comment">//Clean</span></div><div class="line">     [[FTLookupFilter alloc] initWithType:FTLookupTypeClean],</div><div class="line">     <span class="comment">//Peach</span></div><div class="line">     [[FTLookupFilter alloc] initWithType:FTLookupTypePeach],</div><div class="line">     <span class="comment">//Rosy</span></div><div class="line">     [[FTLookupFilter alloc] initWithType:FTLookupTypeRosy],</div><div class="line">     <span class="comment">//Urban</span></div><div class="line">     [[FTLookupFilter alloc] initWithType:FTLookupTypeUrban]</div><div class="line">];</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>调用具体功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//调用美颜</span></div><div class="line">[self.renderer addFilter:self.beautifyNewFilters[<span class="number">0</span>]];</div><div class="line"><span class="comment">//调用描点</span></div><div class="line">[self.renderer addFilter:self.filters[<span class="number">0</span>]];</div><div class="line"><span class="comment">//调用哈哈镜</span></div><div class="line">[self.renderer addFilter:self.currentDistortionFilter];</div><div class="line"><span class="comment">//调用滤镜</span></div><div class="line">[self.renderer addFilter:self.currentLookupFilter];</div><div class="line"><span class="comment">//调用贴纸</span></div><div class="line">[self.renderer addFilter:self.filters[<span class="number">1</span>]];</div></pre></td></tr></table></figure>
</li>
<li><p>去除具体功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//去除美颜</span></div><div class="line">[self.renderer removeFilter:self.beautifyNewFilters[<span class="number">0</span>]];</div><div class="line"><span class="comment">//去除描点</span></div><div class="line">[self.renderer removeFilter:self.filters[<span class="number">0</span>]];</div><div class="line"><span class="comment">//去除哈哈镜</span></div><div class="line">[self.renderer removeFilter:self.currentDistortionFilter];</div><div class="line"><span class="comment">//去除滤镜</span></div><div class="line">[self.renderer removeFilter:self.currentLookupFilter];</div><div class="line"><span class="comment">//去除贴纸</span></div><div class="line">[(FTStickerRenderer *)self.filters[<span class="number">1</span>] setSticker:nil];</div></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="自定义功能扩展"><a href="#自定义功能扩展" class="headerlink" title="自定义功能扩展"></a>自定义功能扩展</h6><ul>
<li><p>增加特定滤镜，进行渲染：</p>
<p>在 sdk入口类中，有一个类型为KWRenderer的渲染类，由他来控制滤镜的增加。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[KiwiFaceSDK.KWRenderer addFilter: GPUImageOutput&lt;GPUImageInput, KWRenderProtocol&gt; *];</div></pre></td></tr></table></figure>
<p>滤镜对象必须遵守GPUImageInput和KWRenderProtocol两个协议才能正常被人脸捕捉和渲染。</p>
</li>
<li><p>删除特定滤镜，停止渲染：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[KiwiFaceSDK.KWRenderer removeFilter: GPUImageOutput&lt;GPUImageInput, KWRenderProtocol&gt; *];</div></pre></td></tr></table></figure>
</li>
<li><p>人脸捕捉之后，在渲染视频帧之前可以对每一帧图像做自定义处理的回调block：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">typedef void (^RenderAndGetFacePointsBlock)(unsigned char *pixels, int format, int width, int height,result_68_t *p_result, int rstNum, int orientation,int faceNum);</div><div class="line">//block属性</div><div class="line">@property (nonatomic, copy)RenderAndGetFacePointsBlock kwRenderBlock;</div></pre></td></tr></table></figure>
<p>block 回调用于在人脸捕捉之后，渲染之前，可以对视频帧进行自定已处理的接口。Block的3个参数可供处理和使用：</p>
<ul>
<li>result ：人脸坐标集合 （可能是多张人脸 是二维数组）</li>
<li>faceNum ：捕捉到的人脸数量</li>
<li>pixelBuffer：单帧的像素流</li>
</ul>
</li>
</ul>
<h6 id="释放内存"><a href="#释放内存" class="headerlink" title="释放内存"></a>释放内存</h6><p>我们建议在离开页面的时候释放内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[KiwiFaceSDK releaseManager];</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/05/24/kiwiDoc/" data-id="cjcbcq6li000h2xzo6iq32d6q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-NSCondition" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/22/NSCondition/" class="article-date">
  <time datetime="2017-05-22T07:56:05.000Z" itemprop="datePublished">2017-05-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/22/NSCondition/">Dispatch Semaphore &amp; NSCondition</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>dispatch_semaphore 使用 <a href="http://www.cnblogs.com/snailHL/p/3906112.html" target="_blank" rel="external">http://www.cnblogs.com/snailHL/p/3906112.html</a></p>
</blockquote>
<h3 id="两个作用"><a href="#两个作用" class="headerlink" title="两个作用"></a>两个作用</h3><p><strong><em> 加锁/数据同步 </em></strong></p>
<p><strong> dispatch_semaphore_create </strong></p>
<p><strong> dispatch_semaphore_signal </strong></p>
<p><strong> dispatch_semaphore_wait </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)methodWithABlock:(DHBLK)blk&#123;</div><div class="line">    blk(@&quot;hahaha&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 测试代码1 单个block</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dispatch_semaphore_t sem = dispatch_semaphore_create(0);      </div><div class="line">[self methodWithABlock:^(id result)&#123;</div><div class="line">    //写block中做的事情</div><div class="line">    //结束等待</div><div class="line">    dispatch_semaphore_signal(sem);</div><div class="line">&#125;];</div><div class="line">//等待信号</div><div class="line">dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</div></pre></td></tr></table></figure>
<p>测试代码2 多个 blcok</p>
<p>xxx.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">dispatch_semaphore_t sem = dispatch_semaphore_create(0);</div><div class="line"></div><div class="line">   [self methodWithABlock:^(id result)&#123;</div><div class="line">       //写block中做的事情</div><div class="line">       dispatch_semaphore_signal(sem);</div><div class="line">       [self methodWithABlock:^(id result)&#123;</div><div class="line">           //写block中做的事情</div><div class="line">           dispatch_semaphore_signal(sem);</div><div class="line">       &#125;];</div><div class="line">   &#125;];</div><div class="line"></div><div class="line">   dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</div><div class="line"></div><div class="line">   dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</div></pre></td></tr></table></figure>
<p>测试代码3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</div><div class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);</div><div class="line"></div><div class="line">__block int j = 0;</div><div class="line">dispatch_async(queue, ^&#123;</div><div class="line">    j = 100;</div><div class="line">    dispatch_semaphore_signal(semaphore);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">NSLog(@&quot;%d&quot;,j);</div><div class="line">// j = 100</div></pre></td></tr></table></figure>
<p>测试代码 4 加锁测试 ,反注释掉//<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">for (int i = 0; i &lt; 100; i++) &#123;</div><div class="line">      dispatch_async(queue, ^&#123;</div><div class="line">          // 相当于加锁</div><div class="line">//            dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">          NSLog(@&quot;i = %zd semaphore = %@&quot;, i, semaphore);</div><div class="line">          // 相当于解锁</div><div class="line">//            dispatch_semaphore_signal(semaphore);</div><div class="line">      &#125;);</div></pre></td></tr></table></figure></p>
<h3 id="NSCondition-的使用"><a href="#NSCondition-的使用" class="headerlink" title="NSCondition 的使用"></a>NSCondition 的使用</h3><blockquote>
<p>NSCondition 的对象实际上作为一个锁和一个线程检查器：锁主要为了当检测条件时保护数据源，执行条件引发的任务；线程检查器主要是根据条件决定是否继续运行线程，即线程是否被阻塞。<br><a href="http://www.jianshu.com/p/5d20c15ae690" target="_blank" rel="external">http://www.jianshu.com/p/5d20c15ae690</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">NSCondition *condition = [[NSCondition alloc] init];</div><div class="line">__block NSMutableArray *products = [[NSMutableArray alloc] initWithCapacity:10];</div><div class="line"></div><div class="line"></div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">    [condition lock];</div><div class="line">    while ([products count] == 0) &#123;</div><div class="line">        NSLog(@&quot;wait for products &quot;);</div><div class="line">        [condition wait];</div><div class="line">    &#125;</div><div class="line">    [products removeObjectAtIndex:0];</div><div class="line">    NSLog(@&quot;custome a product&quot;);</div><div class="line"></div><div class="line">    [condition unlock];</div><div class="line">&#125;);</div><div class="line"></div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line"></div><div class="line">    [condition lock];</div><div class="line"></div><div class="line">    products = [NSMutableArray array];</div><div class="line">    [products addObject:@&quot;oo&quot;];</div><div class="line">    NSLog(@&quot;produce a obj&quot;);</div><div class="line"></div><div class="line">    [condition signal];</div><div class="line">    [condition unlock];</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p> 异步下载图片完成后同步完成数据库再通知UI刷新的机制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (void)receiveMessage:(MessageEntity *)message</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">    NSCondition *condition = [[NSCondition alloc]init];</div><div class="line"></div><div class="line">    [condition lock];</div><div class="line"></div><div class="line">    NSInteger imageCount ;</div><div class="line"></div><div class="line">    void(^unlock)=^()&#123;</div><div class="line"></div><div class="line">        while(!imageCount)</div><div class="line"></div><div class="line">            [condition signal];</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    imageCount++;</div><div class="line"></div><div class="line">dowanloadImageFinished:^(UIImage *image)&#123; //异步下载图片，下载完成的回调中</div><div class="line"></div><div class="line">    imageCount--;</div><div class="line"></div><div class="line">    unlock();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">    while(imageCount)&#123;</div><div class="line"></div><div class="line">        [condition wait];</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [condition unLock];</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="以GPUImage-实现的延时摄影"><a href="#以GPUImage-实现的延时摄影" class="headerlink" title="以GPUImage 实现的延时摄影"></a>以GPUImage 实现的延时摄影</h5><p> 用 semaphore 来筛选(关断)出时间间隔的图像 buffter.筛选出来的buffer 再筛入 WriterInputPixelBufferAdaptor.</p>
<p><strong>     <a href="https://github.com/yangfangxue/GPUImageRecord.git" target="_blank" rel="external">https://github.com/yangfangxue/GPUImageRecord.git</a>
 </strong></p>
<p> <strong> 1.dispatch timer 的用法 </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">__weak typeof(self) ws =self;</div><div class="line">dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0);</div><div class="line">_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</div><div class="line">dispatch_source_set_timer(_timer, dispatch_walltime(NULL, 0), 0.5 * NSEC_PER_SEC, 0);</div><div class="line"></div><div class="line">dispatch_source_set_event_handler(_timer, ^&#123;</div><div class="line">    [ws defaultTimerHandel];</div><div class="line">&#125;);</div><div class="line"></div><div class="line">_seam = dispatch_semaphore_create(0);</div></pre></td></tr></table></figure>
<p>//使用 timer 和销毁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dispatch_resume(_timer);</div><div class="line"></div><div class="line">dispatch_cancel(_timer);</div></pre></td></tr></table></figure></p>
<p><strong> GPUImageVideoCamera 中回调方法CMSampleBufferRef的 lock </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[_camera addTarget:self.preview];</div><div class="line">//获取buffer</div><div class="line">     CVPixelBufferRef imageBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);</div><div class="line">     CVPixelBufferLockBaseAddress(imageBuffer, 0);</div><div class="line"></div><div class="line">     _imageBuffer =  CVPixelBufferRetain(imageBuffer);</div><div class="line">     CVPixelBufferUnlockBaseAddress(imageBuffer, 0);</div></pre></td></tr></table></figure>
<p><strong> 录制配置路径的时候需要检测是否存在,清除历史文件</strong></p>
<p><strong> 完成录制时候加入condition 保护</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[writerInput markAsFinished];</div><div class="line">if(videoWriter.status == AVAssetWriterStatusWriting)&#123;</div><div class="line">    NSCondition *cond = [[NSCondition alloc] init];</div><div class="line">    [cond lock];</div><div class="line">    [videoWriter finishWritingWithCompletionHandler:^&#123;</div><div class="line">        [cond lock];</div><div class="line">        [cond signal];</div><div class="line">        [cond unlock];</div><div class="line">    &#125;];</div><div class="line">    [cond wait];</div><div class="line">    [cond unlock];</div><div class="line"></div><div class="line">    [self savePhotoCmare:self.url];</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="/2017/05/22/NSCondition/" data-id="cjcbcq6l600062xzotb3h28sf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/V2Ray/">V2Ray</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/V2Ray/" style="font-size: 10px;">V2Ray</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/12/异步网络请求控制/">iOS多个网络请求完成后执行下一步</a>
          </li>
        
          <li>
            <a href="/2017/08/28/iOS11升级整理/">iOS11升级整理</a>
          </li>
        
          <li>
            <a href="/2017/08/18/git-repo无差迁移/">git repo无差迁移</a>
          </li>
        
          <li>
            <a href="/2017/08/15/c的注意事项/">c的注意事项</a>
          </li>
        
          <li>
            <a href="/2017/08/09/Lede运行v2ray/">Lede运行v2ray</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Tony Duan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>